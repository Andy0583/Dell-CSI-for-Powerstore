# CSI Snapshot 實作

* 實作內容：
  * 建立PV
  * 使用既有PV，建立PVC
  * PVC Snapshot
  * 使用Snapshot，建立新的PVC
  * 掛載至Pod

### 1.建立Storage Class
```
root@k8s1:~# vi snapshot-class.yaml
```

> ```
> apiVersion: snapshot.storage.k8s.io/v1
> kind: VolumeSnapshotClass
> metadata:
>   name: ps-snapshot
> driver: "csi-powerstore.dellemc.com" 
> deletionPolicy: Delete
> ```

```
root@k8s1:~# kubectl create -f snapshot-class.yaml
volumesnapshotclass.snapshot.storage.k8s.io/ps-snapshot created

root@k8s1:~# kubectl get volumesnapshotclass
NAME          DRIVER                       DELETIONPOLICY   AGE
ps-snapshot   csi-powerstore.dellemc.com   Delete           38s
```

### 2.建立PV
```
root@k8s1:~# vi pv.yaml
```
> ```
> apiVersion: v1
> kind: PersistentVolume
> metadata:
>   name: andy-staticvol
> spec:
>   accessModes:
>     - ReadWriteMany
>   capacity:
>     storage: 100Gi
>   csi:
>     driver: csi-powerstore.dellemc.com
>     volumeHandle: 664d8fd7-d4b6-a0c0-2083-22b2c6c9dd6b/PS556db8bad5cd/nfs
>   persistentVolumeReclaimPolicy: Retain
>   storageClassName: sc-powerstore
>   volumeMode: Filesystem
> ```
```
root@k8s1:~# kubectl create -f pv.yaml
persistentvolume/andy-staticvol created

rroot@k8s1:~# kubectl get pv
NAME             CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS    REASON   AGE
andy-staticvol   100Gi      RWX            Retain           Available           sc-powerstore            5s
```

### 3.建立PVC

* volumeName: 指定PV名稱
```
vi pvc.yaml
```
>```
>kind: PersistentVolumeClaim
>apiVersion: v1
>metadata:
>  name: pvc-static
>  namespace: andy
>spec:
>  accessModes:
>    - ReadWriteMany
>  volumeMode: Filesystem
>  resources:
>    requests:
>      storage: 100Gi
>  storageClassName: sc-powerstore
>  volumeName: andy-staticvol
>```

```
root@k8s1:~# kubectl create -f pvc.yaml
persistentvolumeclaim/pvc-static created

root@k8s1:~# kubectl get pvc -n andy
NAME         STATUS   VOLUME           CAPACITY   ACCESS MODES   STORAGECLASS    AGE
pvc-static   Bound    andy-staticvol   100Gi      RWX            sc-powerstore   7s
```

### 3.建立Snapshot
```
vi snap.yaml
```

>```
> apiVersion: snapshot.storage.k8s.io/v1 
> kind: VolumeSnapshot
> metadata:
>   name: snap-pvc-static
>   namespace: andy
> spec:
>   volumeSnapshotClassName: ps-snapshot
>   source:
>     persistentVolumeClaimName: pvc-static
>```

```
root@k8s1:~# kubectl get volumesnapshot -n andy
NAME              READYTOUSE   SOURCEPVC    SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS   SNAPSHOTCONTENT                                    CREATIONTIME   AGE
snap-pvc-static   true         pvc-static                           100864Mi      ps-snapshot     snapcontent-2134dc2b-2e7b-40ea-9b0b-b33c9476129e   5s             12s
```
* 查看Powerstore該File System上Snapshot資訊
  
![](https://github.com/Andy0583/Dell-CSI-for-Powerstore/blob/main/image/009.png?raw=true)

# CSI Snapshot 實作

* 實作內容：
  * 建立Source PVC
  * 將Source PVC進行Snapshot
  * 使用Snapshot，建立新的PVC
  * 掛載至Pod使用

### 1.建立Storage Class
```
root@k8s1:~# vi snapshot-class.yaml
```

> ```
> apiVersion: snapshot.storage.k8s.io/v1
> kind: VolumeSnapshotClass
> metadata:
>   name: ps-snapshot
> driver: "csi-powerstore.dellemc.com" 
> deletionPolicy: Delete
> ```

```
root@k8s1:~# kubectl create -f snapshot-class.yaml
volumesnapshotclass.snapshot.storage.k8s.io/ps-snapshot created

root@k8s1:~# kubectl get volumesnapshotclass
NAME          DRIVER                       DELETIONPOLICY   AGE
ps-snapshot   csi-powerstore.dellemc.com   Delete           38s
```

### 2.建立PVC
```
vi pvc.yaml
```
>```
>kind: PersistentVolumeClaim
>apiVersion: v1
>metadata:
>  name: pvc-static
>  namespace: andy
>spec:
>  accessModes:
>    - ReadWriteMany
>  volumeMode: Filesystem
>  resources:
>    requests:
>      storage: 100Gi
>  storageClassName: sc-powerstore
>```

```
root@k8s1:~# kubectl create -f pvc.yaml
persistentvolumeclaim/pvc-static created

root@k8s1:~# kubectl get pvc -n andy
NAME         STATUS   VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS    AGE
pvc-static   Bound    csivol-c820c8adbf   100Gi      RWX            sc-powerstore   12s
```

### 3.建立Snapshot
```
vi snap.yaml
```

>```
> apiVersion: snapshot.storage.k8s.io/v1 
> kind: VolumeSnapshot
> metadata:
>   name: snap-pvc-static
>   namespace: andy
> spec:
>   volumeSnapshotClassName: ps-snapshot
>   source:
>     persistentVolumeClaimName: pvc-static
>```

```
root@k8s1:~# kubectl create -f snap.yaml
volumesnapshot.snapshot.storage.k8s.io/snap-pvc-static created

root@k8s1:~# kubectl get volumesnapshot -n andy
NAME              READYTOUSE   SOURCEPVC    SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS   SNAPSHOTCONTENT                                    CREATIONTIME   AGE
snap-pvc-static   true         pvc-static                           100Gi         ps-snapshot     snapcontent-9e3683f2-6250-4b98-b7b3-f1ea327678bb   4s             9s
```
* 查看Powerstore該File System上Snapshot資訊
  
![](https://github.com/Andy0583/Dell-CSI-for-Powerstore/blob/main/image/009.png?raw=true)

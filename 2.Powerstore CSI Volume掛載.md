# 動態PV
### 0.建立測試使用Name Space 
```
root@k8s1:~# kubectl create ns andy
namespace/andy created

root@k8s1:~# kubectl get ns
NAME              STATUS   AGE
andy              Active   17m
default           Active   22h
kube-flannel      Active   22h
kube-node-lease   Active   22h
kube-public       Active   22h
kube-system       Active   22h
ps                Active   3h38m
```

### 1.建立Storage Class
* 查看Powerstore Array ID資訊
  
![](https://github.com/Andy0583/Dell-CSI-for-Powerstore/blob/main/image/005.png?raw=true)

* 查看Powerstore NAS Name資訊

![](https://github.com/Andy0583/Dell-CSI-for-Powerstore/blob/main/image/006.png?raw=true)

```
root@k8s1:~# vi sc.yaml
```
```
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: "sc-powerstore"
  namespace: "ps"
provisioner: "csi-powerstore.dellemc.com"
parameters:
  arrayID: "PS556db8bad5cd"
  csi.storage.k8s.io/fstype: "nfs"
  nasName: "andy-nas"
  allowRoot: "true"
reclaimPolicy: Delete
allowVolumeExpansion: true
volumeBindingMode: Immediate
```
```
root@k8s1:~# kubectl create -f sc.yaml
storageclass.storage.k8s.io/sc-powerstore created

root@k8s1:~# kubectl get sc
NAME            PROVISIONER                  RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
sc-powerstore   csi-powerstore.dellemc.com   Delete          Immediate           true                   63s
```


### 2.建立PVC
```
root@k8s1:~# vi pvc.yaml
```
```
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-powerstore
  namespace: andy
spec:
  accessModes:
    - ReadWriteMany
  volumeMode: Filesystem
  resources:
    requests:
      storage: 300Gi
  storageClassName: sc-powerstore
```
```
root@k8s1:~# kubectl create -f pvc.yaml
persistentvolumeclaim/pvc-powerstore created

root@k8s1:~# kubectl get pvc -n andy
NAME             STATUS   VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS    AGE
pvc-powerstore   Bound    csivol-668ed320cd   300Gi      RWX            sc-powerstore   29s

root@k8s1:~# kubectl get pv
NAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS    REASON   AGE
csivol-668ed320cd   300Gi      RWX            Delete           Bound    andy/pvc-powerstore   sc-powerstore            47s
```

* 查看Powerstore File system資訊，是否有正確建立

![](https://github.com/Andy0583/Dell-CSI-for-Powerstore/blob/main/image/003.png?raw=true)

### 3.建立Pod
```
root@k8s1:~# vi pod.yaml
```
```
kind: podtest
apiVersion: v1
metadata:
  name: pod
  namespace: andy
spec:
  volumes:
  - name: andyvol
    persistentVolumeClaim:
      claimName: pvc-powerstore
  containers:
  - name: nginx
    image: nginx
    volumeMounts:
    - mountPath: "/andy"
      name: andyvol
```
```
root@k8s1:~# kubectl get pod -n andy
NAME       READY   STATUS    RESTARTS   AGE
podtest    1/1     Running   0          20s
```

* 檢查Pod是否正確掛載PowerStore NFS
```
root@k8s1:~# kubectl exec -ti podtest -n andy -- /bin/sh

# ls
andy  boot  docker-entrypoint.d   etc   lib    media  opt   root  sbin  sys  usr
bin   dev   docker-entrypoint.sh  home  lib64  mnt    proc  run   srv   tmp  var

# df -h
Filesystem                                       Size  Used Avail Use% Mounted on
overlay                                           98G  9.4G   84G  11% /
tmpfs                                             64M     0   64M   0% /dev
192.168.131.20:/csivol-668ed320cd/common_folder  302G  1.6G  300G   1% /andy
/dev/mapper/ubuntu--vg-ubuntu--lv                 98G  9.4G   84G  11% /etc/hosts
shm                                               64M     0   64M   0% /dev/shm
tmpfs                                             16G   12K   16G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs                                            7.9G     0  7.9G   0% /proc/acpi
tmpfs                                            7.9G     0  7.9G   0% /proc/scsi
tmpfs                                            7.9G     0  7.9G   0% /sys/firmware

# exit
```

### 4.刪除Pod
```
root@k8s1:~# kubectl delete -f pod.yaml
pod "pod" deleted

root@k8s1:~# kubectl get pod -n andy
No resources found in andy namespace.
```

### 5.刪除PVC
```
root@k8s1:~# kubectl delete -f pvc.yaml
persistentvolumeclaim "pvc-powerstore" deleted

root@k8s1:~# kubectl get pvc -n andy
No resources found in andy namespace.

root@k8s1:~# kubectl get pv
No resources found
```

* 於PowerStore中，該File System已刪除

![](https://github.com/Andy0583/Dell-CSI-for-Powerstore/blob/main/image/004.png?raw=true)

# 靜態PV
### 1.建立Storage Class
```
root@k8s1:~# vi sc.yaml
```
```
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: "sc-powerstore"
  namespace: "andy"
provisioner: "csi-powerstore.dellemc.com"
parameters:
  arrayID: "PS556db8bad5cd"
  csi.storage.k8s.io/fstype: "nfs"
  nasName: "andy-nas"
  allowRoot: "true"
reclaimPolicy: Delete
allowVolumeExpansion: true
volumeBindingMode: Immediate
```
```
root@k8s1:~# kubectl create -f sc.yaml
storageclass.storage.k8s.io/sc-powerstore created

root@k8s1:~# kubectl get sc
NAME            PROVISIONER                  RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
sc-powerstore   csi-powerstore.dellemc.com   Delete          Immediate           true                   63s
```

### 2.建立PV
* 使用既有Powerstore filesystem，掛載為PV，需先紀錄該filesystem ID。

![](https://github.com/Andy0583/Dell-CSI-for-Powerstore/blob/main/image/007.png?raw=true)
* volumeHandle格式為<volume-id/globalID/protocol><BR>
* 本範例為<664d8fd7-d4b6-a0c0-2083-22b2c6c9dd6b/PS556db8bad5cd/nfs>

```
root@k8s1:~# vi pv.yaml
```
```
apiVersion: v1
kind: PersistentVolume
metadata:
  name: andy-staticvol
spec:
  accessModes:
  - ReadWriteMany
  capacity:
    storage: 100Gi
  csi:
    driver: csi-powerstore.dellemc.com
    volumeHandle: 664d8fd7-d4b6-a0c0-2083-22b2c6c9dd6b/PS556db8bad5cd/nfs
  persistentVolumeReclaimPolicy: Retain
  storageClassName: sc-powerstore
  volumeMode: Filesystem
```
```
root@k8s1:~# kubectl create -f pv.yaml
persistentvolume/andy-staticvol created

rroot@k8s1:~# kubectl get pv
NAME             CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS    REASON   AGE
andy-staticvol   100Gi      RWX            Retain           Available           sc-powerstore            5s
```

### 3.建立PVC

* volumeName: 指定PV名稱
```
vi pvc.yaml
```
```
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-static
  namespace: andy
spec:
  accessModes:
   - ReadWriteMany
  volumeMode: Filesystem
  resources:
    requests:
      storage: 60Gi
  storageClassName: sc-powerstore
  volumeName: andy-staticvol
```

```
root@k8s1:~# kubectl create -f pvc.yaml
persistentvolumeclaim/pvc-static created

root@k8s1:~# kubectl get pvc -n andy
NAME         STATUS   VOLUME           CAPACITY   ACCESS MODES   STORAGECLASS    AGE
pvc-static   Bound    andy-staticvol   100Gi      RWX            sc-powerstore   7s
```

### 4.刪除PVC與PV
```
root@k8s1:~# kubectl delete pvc pvc-static -n andy
persistentvolumeclaim "pvc-static" deleted

root@k8s1:~# kubectl delete pv andy-staticvol
persistentvolume "andy-staticvol" deleted
```

* 查看Powerstore File System，"andy-static"依舊存在

![](https://github.com/Andy0583/Dell-CSI-for-Powerstore/blob/main/image/008.png?raw=true)
